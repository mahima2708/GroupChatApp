<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GroupChat</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.15/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="overflow-hidden">
    <!-- Navigation -->
    <nav class="bg-teal-800">
        <header class="text-white py-2 text-center">
            <h1 class="text-white">GroupChat App</h1>
        </header>
    </nav>

    <!-- Main Content -->
    <div class="flex flex-col sm:flex-row h-screen ">
        <!-- Sidebar -->
        <div class="border-2 border-solid border-teal-600 mt-2 mb-2 rounded-lg sm:w-1/3 p-2 sm:top-0 h-5/6 sm:h-5/6 bg-white overflow-y-auto">
            <div class="flex justify-between">
                <button class="ml-2 bg-gray-800 w-full sm:w-28 h-8 rounded-xl text-white mb-2" onClick="createGroup(event)">New Group</button>
                <button class="bg-gray-800 w-full sm:w-20 h-8 rounded-xl text-white mb-2" onClick="logout(event)">Logout</button>
            </div>
            <div>
                <ul id="grpList">
                </ul>
                
            </div>
        </div>

        <!-- Message Display Area -->

        <div class="border-2 border-solid border-teal-600  mt-2 ml-2 mb-2 rounded-lg sm:w-2/3 p-2 sm:sticky h-5/6 sm:h-5/6 bg-white flex justify-between">
            <div id="group_name" class=" hidden px-10 my-2 flex justify-between">
                <h1 class=" text-green ">My2ndGroup</h1>
                <div class="space-x-2">
                    <button class="bg-gray-800 w-28 h-8 rounded-xl text-white fixed right-28" onClick="createGroup(event)">Edit</button>
                    <button class="bg-gray-800 w-20 h-8 rounded-xl text-white fixed right-10" onClick="logout(event)">Info</button>
                </div>
            </div>
            
            
           
            <div class="px-10 my-2 flex justify-center">
                <ul class="overflow-auto" id="messages"></ul>
            </div>
        </div>
    </div>

   <!-- <-- Message Input and Group Creation Div -->
     <div class=" justify-between items-center border-2 border-solid border-gray-950 bg-gray-300 text-black py-2 text-center fixed bottom-2 w-screen">
        <div class="flex flex-col sm:flex-row items-center justify-center">
            <label for="userInput" class="font-bold">Enter message:</label>
            <input type="text" id="userInput" name="userInput" class="mb-1 mr-2 h-10 w-full sm:w-2/3">
            <button class="bg-gray-800 w-full sm:w-36 h-8 rounded-xl text-white mb-2 ml-12" onClick="sendMessage(event)">Send</button>
        </div>
    </div>
         
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>

        function grouphandler(){
            if(localStorage.getItem('currentgrp')!= null){
              const grpDiv = document.getElementById("group_name");
              grpDiv.classList.toggle('hidden');
              const h1Element = grpDiv.querySelector('h1');
              const groupname = localStorage.getItem('currentgrp');

               h1Element.textContent = groupname;

            }
        }

        grouphandler()
        async function sendMessage(event){
            event.preventDefault()
            try{
                const userInput = document.getElementById("userInput").value;
                const messages = {
                    message: userInput
                }
                const token = localStorage.getItem('token');
                const message = await axios.post('http://localhost:3000/messages',  messages  ,{headers: {"Authorisation": token} })
                if(message.status===200){
                    console.log("23232",message.data.message);
                    showOnScreen(message.data.message,0)
                }
             }
            catch(err){
                console.log(err);
            }
        }
        
        window.addEventListener('DOMContentLoaded', ()=>{
         async function getandsavetolocalstorage(){
            const node = document.getElementById('messages');
            node.innerHTML= " ";
            const lclstorage = localStorage.getItem('msgs')
            console.log("is it blank", lclstorage);
            if(lclstorage===null){
                const idval =0;
                await axios.get(`http://localhost:3000/message/${idval}`).then(async(response)=>{
               console.log("@#@#@#@#", response);
               const msgArray = [];
               var lower_bound =0;
               var upper_bound = 11;
               if (response.data.newdata.length>10){
                lower_bound = response.data.newdata.length-10
                upper_bound = response.data.newdata.length
               }
               for(var i =lower_bound;i<upper_bound;i++){
                var k=i+1;
                const chats={
                    id: k,
                    name:response.data.newdata[i].name,
                    message: response.data.newdata[i].message,
                };
                msgArray.push(chats);
            }
                const savemsg = JSON.stringify(msgArray);
                localStorage.setItem('msgs', savemsg)
               
               fetchFromStorage()
            }).catch((err)=>{
                console.log(err);
            })
            }
            else{
                const lclstor = localStorage.getItem('msgs')
            const parseentry = JSON.parse(lclstor)
             const lastid  = parseentry.length;
             const idval = parseentry[lastid-1].id;
             console.log("isssssssssss", idval)
             await axios.get(`http://localhost:3000/message/${idval}`).then(async(response)=>{
               console.log("@#@#@#@#", response);
            if(response.data.newdata.length!=0){
               const msgArray = [];
               var lower_bound =0;
               var upper_bound = 1;
               const lclstorage = localStorage.getItem('msgs')
             localStorage.removeItem('msgs');
               const pentry = JSON.parse(lclstorage)
               const filteredArray = pentry.filter(entry => entry.id !== idval-10);

            // Save the modified array back to localStorage
            localStorage.setItem('msgs', JSON.stringify(filteredArray));
            const updated = localStorage.getItem('msgs')
            const parseUpdate = JSON.parse(updated);
            
               var fethd =idval
               for(var i =lower_bound;i<upper_bound;i++){
                var k=fethd+1;
                fethd++;
                const chats={
                    id: k,
                    name:response.data.newdata[i].name,
                    message: response.data.newdata[i].message,
                };
                msgArray.push(chats);
            }
            const newmsgs = parseUpdate.concat(msgArray)
                const savemsg = JSON.stringify(newmsgs);
                localStorage.setItem('msgs', savemsg)
               
               fetchFromStorage()
            }
            else{
                console.log("No new entry");
                fetchFromStorage()
            }
        }).catch((err)=>{
                console.log(err);
            })

            }  
            }
            // getandsavetolocalstorage();
        
    //     setInterval(() => {
    //         getandsavetolocalstorage();
    // }, 10000); 
           
           
        })

        async function displaygroupName() {
  const token = localStorage.getItem('token');
  const grList = document.getElementById('grpList');
  if (localStorage.getItem("group") !== null) {
    const groups = await axios.get('http://localhost:3000/getgroups', {
      headers: { "Authorisation": token } // Note the corrected spelling of "Authorization"
    }).then((response) => {
      console.log("groups are", response.data.message.length);
      for (var i = 0; i < response.data.message.length; i++) {
        const listItem = document.createElement('li');
        listItem.id = response.data.message[i].id;
        listItem.className = "text-green bg-gray-300 p-2 border-2 border-solid border-black-800";
        listItem.innerHTML = `<span class="text-green text-lg">${response.data.message[i].name}</span>`;
        
        // Add a click event listener to the created list item
        listItem.addEventListener('click', function() {
          // Handle the click event here, for example, alert the ID
          console.log("its almost done ")
        });

        grList.appendChild(listItem);
      }
    })
  }
}

   
function  showOnScreen(data,i){
    document.getElementById('userInput').value = "";
    const firstNode = documenputData = 0;
    if(i%2!=0){
        inputData = `

  <li class="mr-4 p-2 bg-gray-300 rt.getElementById('messages');
    var inounded-lg ">
    <span class=" text-black text-green text-sm underline"> ${data.name }: </span><br>
    <span class="ml-2 font-semibold text-black">  ${data.message}</span>
  </li>
`;

              }

              else{
             inputData = `<li class = "mr-4 p-2 bg-stone-200  rounded-lg mb-2 "> 
                <span class=" text-black text-green text-sm underline"> ${data.name }: </span><br>
                <span class="ml-2 font-semibold text-black">  ${data.message}</span>
                             </li>`
              }
           
  firstNode.innerHTML = firstNode.innerHTML + inputData;

}
async function fetchFromStorage(){
const msgArray = localStorage.getItem('msgs');
const arr = JSON.parse(msgArray);
for(var i=0;i<arr.length;i++){
    showOnScreen(arr[i],i)
}
console.log("Array is @@@", arr[0].id);

}


displaygroupName()

      

        async function createGroup(event){
            event.preventDefault()
            try{
                 window.location.href = "groupcreation"
            }
            catch(err){
                console.log(err);
            }
        }

//         async function addUsers(){

//             const token = localStorage.getItem('token')
//             const users = await axios.get('http://localhost:3000/users', {headers: {"Authorisation": token} })
//             if(users.status===200){
//                 var container = document.getElementById('usersList');
//                     container.classList.toggle('hidden')
//                 console.log("all users", users.data.newdata[0].name)
//                 var firstNode = "";

//                 for(var i=0;i<users.data.newdata.length;i++){
//                     firstNode = document.getElementById('users');
                    
//     var inputData = 0;
//         inputData = `

//   <li class="mr-4 p-2 bg-gray-300 rounded-lg flex justify-between items-center ">

//     <div class="txt-black font-bold text-lg ">${users.data.newdata[i].name }  </div>
    
//     <button class= "bg-gray-800 text-white rounded-xl ml-2 h-8 w-14 mb-2">Add </button> 
      
//   </li>
// `;

//  firstNode.innerHTML = firstNode.innerHTML + inputData;

 
//                 }
              
//             }
           

//         }

       
    </script>


    <script src="https://cdn.tailwindcss.com"></script>  
</body>
</html>
